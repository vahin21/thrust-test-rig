<!DOCTYPE html>
<html>
<head>
  <title>Static Thrust Test Rig</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      background: #111;
      color: white;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
    }
    input {
      padding: 8px;
      font-size: 16px;
      margin: 5px;
    }
    #fireBtn {
      background: red;
      color: white;
    }
  </style>
</head>
<body>

<h1>Static Thrust Test Rig Dashboard</h1>

<h2 id="thrust">Thrust: 0 N</h2>

<canvas id="chart" width="800" height="400"></canvas>

<br><br>

<button id="fireBtn" onclick="fire()">FIRE</button>
<button onclick="tare()">TARE</button>

<br><br>

<h3>Calibration</h3>
<input type="number" id="calFactor" placeholder="Enter scale factor">
<button onclick="calibrate()">Apply Calibration</button>

<script>
let ctx = document.getElementById('chart').getContext('2d');

let chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Thrust (N)',
      data: [],
      borderColor: 'lime',
      borderWidth: 2,
      fill: false,
      tension: 0.1
    }]
  },
  options: {
    animation: false,
    scales: {
      x: { title: { display: true, text: 'Time' } },
      y: { title: { display: true, text: 'Thrust (N)' } }
    }
  }
});

let startTime = Date.now();

async function fetchData(){
  const res = await fetch('/api/data');
  const data = await res.json();

  const thrust = parseFloat(data.thrust);

  document.getElementById("thrust").innerText =
    "Thrust: " + thrust.toFixed(2) + " N";

  let time = ((Date.now() - startTime) / 1000).toFixed(1);

  chart.data.labels.push(time);
  chart.data.datasets[0].data.push(thrust);

  if(chart.data.labels.length > 100){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }

  chart.update();
}

setInterval(fetchData, 500);

async function fire(){
  await fetch('/api/fire', { method:'POST' });
}

async function tare(){
  await fetch('/api/tare', { method:'POST' });
}

async function calibrate(){
  const factor = document.getElementById("calFactor").value;

  await fetch('/api/calibrate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ factor })
  });

  alert("Calibration factor sent to ESP");
}
</script>

</body>
</html>
